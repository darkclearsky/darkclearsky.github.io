<!DOCTYPE html>
<html>
<meta charset = "UTF-8">
<style type="text/css">
	.LText { font-family: Courier; font-size:12px; font-weight:bold; vertical-align: top; text-align: left; background-color: white; }
	.RText { font-family: Courier; font-size:12px; font-weight:bold; vertical-align: top; text-align: right; background-color: white; }
	.CText { font-family: Courier; font-size:12px; font-weight:bold; vertical-align: top; text-align: center; color: black; background-color: white; }
	.CCText { font-family: Courier; font-size:12px; font-weight:bold; vertical-align: top; text-align: center; color: blue; background-color: white; }
	.ButtonC { font-family: Courier; padding-left:0px; padding-right:0px; font-size:10px; font-weight:bold; height:20px; width:40px; vertical-align: middle; text-align: center; color: blue; background-color: white; }
    .Table { display:table }
    .Row { display: table-row; background-color: white; height: 40px; }
    .Cell { display: table-cell; vertical-align: top; text-align: left; border: 0px solid black; padding-left: 5px; padding-right: 5px; }
    .MapCell { display: table-cell; column-span:2; vertical-align: top; border: 0px solid black; padding-left: 0px; padding-right: 0px; width:1000px}
	.Slider { width: 200px; height: 10px; -webkit-appearance: none; -webkit-transition:0.2s; background-color:lightgray; outline:none; opacity:0.7s; transition: opacity 0.2s; }
	.Slider:hover { opacity:1 }
	.Slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 35px; height: 25px; background: black; cursor: pointer; }
	.Slider::-moz-range-thumb { width: 25px; height: 15px; background: black; cursor: pointer; }
	.ShortSlider { width:100px; height: 25px; -webkit-appearance: none; -webkit-transition:0.2s; background-color:lightgray; outline:none; opacity:0.7s; transition: opacity 0.2s; }
	.ShortSlider:hover { opacity:1 }
	.ShortSlider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 25px; height: 25px; background: #4CAF50; cursor: pointer; }
	.ShortSlider::-moz-range-thumb { width: 25px; height: 25px; background: #4CAF50; cursor: pointer; }
</style>
<body>
<div class = "Table">
	<div class = "Row">
		<div class = "MapCell">
			<canvas id="USAMap" width=1200 height=640 style="border:0px solid #ffffff; background-color:white;">
			Your browser does not support HTML5
			</canvas>
		</div>
	</div>
	<div class = "Row" id="Controls" style="visibility:collapse;">
			<div class = "Cell">
				<button type="button" class=ButtonC id="ReverseButton">&#10074&#x25c0&#x25c0</button>
				<button type="button" class=ButtonC id="Backward1FrameButton">&#10074&#x25c0</button>
				<button type="button" class=ButtonC id="PauseButton">&#10074&#10074</button>
				<button type="button" class=ButtonC id="PlayButton">&#x25b6</button>
				<button type="button" class=ButtonC id="Forward1FrameButton">&#x25b6&#10074</button>
				<button type="button" class=ButtonC id="FastForwardButton">&#x25b6&#x25b6&#10074</button>

				<label class = "LText">Date Select:</label>
				<input type="range" class=Slider min=0 max=1 value=1 id="DateCtrl">
				<label class = "CText" id="CurrentDateSet">No Date</label>
				<label></label>
				<label class = "LText"><font size=-1><i>|</i></font>Map Select:</label>
				<!-- <input type="range" class=ShortSlider min=0 max=1 value=1 id="DisplayCtrl"> -->
				<select class = "CText" id=DisplaySelect></select>
				<!-- <label class = "CText" id="DisplaySet">Map Description</label> -->
			</div>
	</div>
	<div class = "Row" id="MessageArea">
		<label class = "CCText" id="StatusText">One moment - loading data, this may take a while.</label>
	</div>
</div>

</body>

<script src=USBorders.js></script>
<script src=Cities.js></script>
<script src=USAData.js></script>
<script src=USAData_60.js></script>
<script src=USAData_61.js></script>
<script src=USAData_62.js></script>
<script src=USAData_63.js></script>
<script src=USAData_64.js></script>
<script src=USAData_65.js></script>
<script src=USAData_66.js></script>
<script src=USAData_67.js></script>
<script src=USAData_68.js></script>
<script src=USAData_69.js></script>
<script src=USAData_70.js></script>
<script src=USAData_71.js></script>
<script src=USAData_72.js></script>
<script src=USAData_73.js></script>
<script src=USAData_74.js></script>
<script src=USAData_75.js></script>
<script src=USAData_76.js></script>
<script src=USAData_77.js></script>
<script src=USAData_78.js></script>
<script src=USAData_79.js></script>
<script src=USAData_80.js></script>
<script src=USAData_81.js></script>
<script src=USAData_82.js></script>
<script src=USAData_83.js></script>
<script src=USAData_84.js></script>
<script src=USAData_85.js></script>
<script src=USAData_86.js></script>
<script src=USAData_87.js></script>
<script src=USAData_88.js></script>
<script src=USAData_89.js></script>
<script src=USAData_90.js></script>
<script src=USAData_91.js></script>
<script src=USAData_92.js></script>
<script src=USAData_93.js></script>
<script src=USAData_94.js></script>
<script src=USAData_95.js></script>
<script src=USAData_96.js></script>
<script src=USAData_97.js></script>
<script src=USAData_98.js></script>
<script src=USAData_99.js></script>
<script src=USAData_100.js></script>
<script src=USAData_101.js></script>
<script src=USAData_102.js></script>
<script src=USAData_103.js></script>
<script src=USAData_104.js></script>
<script src=USAData_105.js></script>
<script src=USAData_106.js></script>
<script src=USAData_107.js></script>
<script src=USAData_108.js></script>
<script src=USAData_109.js></script>
<script src=USAData_110.js></script>
<script src=USAData_111.js></script>
<script src=USAData_112.js></script>
<script src=USAData_113.js></script>
<script src=USAData_114.js></script>
<script src=USAData_115.js></script>
<script src=USAData_116.js></script>
<script src=USAData_117.js></script>
<script src=USAData_118.js></script>
<script src=USAData_119.js></script>
<script src=USAData_120.js></script>
<script src=USAData_121.js></script>
<script src=USAData_122.js></script>
<script src=USAData_123.js></script>
<script src=USAData_124.js></script>
<script src=USAData_125.js></script>
<script src=USAData_126.js></script>
<script src=USAData_127.js></script>
<script src=USAData_128.js></script>
<script src=USAData_129.js></script>
<script src=USAData_130.js></script>
<script src=USAData_131.js></script>
<script src=USAData_132.js></script>
<script src=USAData_133.js></script>
<script src=USAData_134.js></script>
<script src=USAData_135.js></script>
<script src=USAData_136.js></script>
<script src=USAData_137.js></script>
<script src=USAData_138.js></script>
<script src=USAData_139.js></script>
<script src=USAData_140.js></script>
<script src=USAData_141.js></script>
<script src=USAData_142.js></script>
<script src=USAData_143.js></script>
<script src=USAData_144.js></script>
<script src=USAData_145.js></script>
<script src=USAData_146.js></script>
<script src=USAData_147.js></script>
<script src=USAData_148.js></script>
<script src=USAData_149.js></script>
<script src=USAData_150.js></script>
<script src=USAData_151.js></script>
<script src=USAData_152.js></script>
<script src=USAData_153.js></script>
<script src=USAData_154.js></script>
<script src=USAData_155.js></script>
<script src=USAData_156.js></script>
<script src=USAData_157.js></script>
<script src=USAData_158.js></script>
<script src=USAData_159.js></script>
<script src=USAData_160.js></script>
<script src=USAData_161.js></script>
<script src=USAData_162.js></script>
<script src=USAData_163.js></script>
<script src=USAData_164.js></script>
<script src=USAData_165.js></script>
<script src=USAData_166.js></script>
<script src=USAData_167.js></script>
<script src=USAData_168.js></script>
<script src=USAData_169.js></script>
<script src=USAData_170.js></script>
<script src=USAData_171.js></script>
<script src=USAData_172.js></script>
<script src=USAData_173.js></script>
<script src=USAData_174.js></script>
<script src=USAData_175.js></script>
<script src=USAData_176.js></script>
<script src=USAData_177.js></script>
<script src=USAData_178.js></script>
<script src=USAData_179.js></script>
<script src=USAData_180.js></script>
<script src=USAData_181.js></script>
<script src=USAData_182.js></script>
<script src=USAData_183.js></script>
<script src=USAData_184.js></script>
<script src=USAData_185.js></script>
<script src=USAData_186.js></script>
<script src=USAData_187.js></script>
<script src=USAData_188.js></script>
<script src=USAData_189.js></script>
<script src=USAData_190.js></script>
<script src=USAData_191.js></script>
<script src=USAData_192.js></script>
<script src=USAData_193.js></script>
<script src=USAData_194.js></script>
<script src=USAData_195.js></script>
<script src=USAData_196.js></script>
<script src=USAData_197.js></script>
<script src=USAData_198.js></script>
<script src=USAData_199.js></script>
<script src=USAData_200.js></script>
<script src=USAData_201.js></script>
<script src=USAData_202.js></script>
<script src=USAData_203.js></script>
<script src=USAData_204.js></script>
<script src=USAData_205.js></script>
<script src=USAData_206.js></script>
<script src=USAData_207.js></script>
<script src=USAData_208.js></script>
<script src=USAData_209.js></script>
<script src=USAData_210.js></script>
<script src=USAData_211.js></script>
<script src=USAData_212.js></script>
<script src=USAData_213.js></script>
<script src=USAData_214.js></script>
<script src=USAData_215.js></script>
<script src=USAData_216.js></script>
<script src=USAData_217.js></script>
<script src=USAData_218.js></script>
<script src=USAData_219.js></script>
<script src=USAData_220.js></script>
<script src=USAData_221.js></script>
<script src=USAData_222.js></script>
<script src=USAData_223.js></script>
<script src=USAData_224.js></script>
<script src=USAData_225.js></script>
<script src=USAData_226.js></script>
<script src=USAData_227.js></script>
<script src=USAData_228.js></script>
<script src=USAData_229.js></script>
<script src=USAData_230.js></script>
<script src=USAData_231.js></script>
<script src=USAData_232.js></script>
<script src=USAData_233.js></script>
<script src=USAData_234.js></script>
<script src=USAData_235.js></script>
<script src=USAData_236.js></script>
<script src=USAData_237.js></script>
<script src=USAData_238.js></script>
<script src=USAData_239.js></script>
<script src=USAData_240.js></script>
<script src=USAData_241.js></script>
<script src=USAData_242.js></script>
<script src=USAData_243.js></script>
<script src=USAData_244.js></script>
<script src=USAData_245.js></script>
<script src=USAData_246.js></script>
<script src=USAData_247.js></script>
<script src=USAData_248.js></script>
<script src=USAData_249.js></script>
<script src=USAData_250.js></script>
<script src=USAData_251.js></script>
<script src=USAData_252.js></script>
<script src=USAData_253.js></script>
<script src=USAData_254.js></script>
<script src=USAData_255.js></script>
<script src=USAData_256.js></script>
<script src=USAData_257.js></script>
<script src=USAData_258.js></script>
<script src=USAData_259.js></script>
<script src=USAData_260.js></script>
<script src=USAData_261.js></script>
<script src=USAData_262.js></script>
<script src=USAData_263.js></script>
<script src=USAData_264.js></script>
<script src=USAData_265.js></script>
<script src=USAData_266.js></script>
<script src=USAData_267.js></script>
<script src=USAData_268.js></script>
<script src=USAData_269.js></script>
<script src=USAData_270.js></script>
<script src=USAData_271.js></script>
<script src=USAData_272.js></script>
<script src=USAData_273.js></script>
<script src=USAData_274.js></script>
<script src=USAData_275.js></script>
<script src=USAData_276.js></script>
<script src=USAData_277.js></script>
<script src=USAData_278.js></script>
<script src=USAData_279.js></script>
<script src=USAData_280.js></script>

<script>

var MinLat = 25;
var MaxLat = 49;
var MinLng = -124;
var MaxLng = -67;
var MagnifierX = 17;
var MagnifierY = 19;
function MapToCanvasX(x) { return((x + 125) * MagnifierX); }
function MapToCanvasY(y) { return((50 - y) * MagnifierY); }
// function MapToCanvasX(x) { return(x + (-1 * (MinLng-1)) * MagnifierX); }
// function MapToCanvasY(y) { return(((MaxLat+1) - y) * MagnifierY); }
function MapToHeatMapX(x) { return(Math.floor(x - MinLng)); }
function MapToHeatMapY(y) { return(Math.floor(MaxLat - (y - MinLat))); }

function DecToHex(h)
{
	if(h < 0)
		return("00");
	if(h < 15)
		return("0" + h.toString(16));
	if(h > 255)
		return("ff");
	return(h.toString(16));
}

function ClearScreen()
{
	// clear canvas
	ctx.globalAlpha = 1.0;
	// ctx.fillStyle = "darkgray";
	ctx.fillStyle = "white";
	ctx.fillRect(0,0,canvas.width,canvas.height);
}

function DrawUSAMap()
{
	var x,y;
	var Lat,Lng;
	var Radius;
	// draw map
	ctx.lineWidth = 1;
	// ctx.fillStyle = "#ffffff";
	// ctx.strokeStyle = "#b2babb";
	ctx.strokeStyle = "black";
	for(x=0;x<Object.keys(States).length;x++)
	{
		ctx.beginPath();
		ctx.moveTo(	MapToCanvasX(Object.values(States)[x].Coordinates[0].lng),
					MapToCanvasY(Object.values(States)[x].Coordinates[0].lat));
		for(y=1;y<Object.values(States)[x].Coordinates.length;y++)
		{
			ctx.lineTo(	MapToCanvasX(Object.values(States)[x].Coordinates[y].lng),
						MapToCanvasY(Object.values(States)[x].Coordinates[y].lat))
		}
		ctx.closePath();
		// ctx.fill();
		ctx.stroke();

		/*
		for(y=0;y<Object.values(States)[x].Coordinates.length;y++)
		{
			if(MinLng > Object.values(States)[x].Coordinates[y].lng)
				MinLng = Object.values(States)[x].Coordinates[y].lng;
			if(MaxLng < Object.values(States)[x].Coordinates[y].lng)
				MaxLng = Object.values(States)[x].Coordinates[y].lng;
			if(MinLat > Object.values(States)[x].Coordinates[y].lat)
				MinLat = Object.values(States)[x].Coordinates[y].lat;
			if(MaxLat < Object.values(States)[x].Coordinates[y].lat);
				MaxLat = Object.values(States)[x].Coordinates[y].lat;
		}
		*/
	}

	// draw city locations
	ctx.globalAlpha = 1.0;
	ctx.strokeStyle = "darkgray";
	ctx.lineWidth = 1;
	ctx.font = "normal 8pt courier";
	for(x=0;x<CityData.length;x++)
	{
		Lat = MapToCanvasY(CityData[x].Lat);
		Lng = MapToCanvasX(CityData[x].Lng);

		if(CityData[x].Pop2010 > 3000000)
			Radius = 5;
		else
			if(CityData[x].Pop2010 > 2000000)
				Radius = 4;
			else
				if(CityData[x].Pop2010 > 1000000)
					Radius = 3;
				else
					Radius = 2;

		ctx.fillStyle = "black";
		ctx.beginPath();
		ctx.arc(Lng,Lat,Radius,0,2*Math.PI);
		ctx.fill();
		ctx.closePath();
		switch(CityData[x].Orient)
		{
			case	0	:
							ctx.textAlign = "left";
							ctx.textBaseline = "middle";
							ctx.fillText(" " + CityData[x].City,MapToCanvasX(CityData[x].Lng),MapToCanvasY(CityData[x].Lat));
							break;
			case	1	:
							ctx.textAlign = "right";
							ctx.textBaseline = "middle";
							ctx.fillText(CityData[x].City + " ",MapToCanvasX(CityData[x].Lng),MapToCanvasY(CityData[x].Lat));
							break;
			case	2	:
							ctx.textAlign = "center";
							ctx.textBaseline = "top";
							ctx.fillText(CityData[x].City,MapToCanvasX(CityData[x].Lng),MapToCanvasY(CityData[x].Lat)+2);
							break;
			case	3	:
							ctx.textAlign = "center";
							ctx.textBaseline = "bottom";
							ctx.fillText(CityData[x].City,MapToCanvasX(CityData[x].Lng),MapToCanvasY(CityData[x].Lat)+2);
							break;
		}
		// ctx.strokeText(CityData[x].City,MapToCanvasX(CityData[x].Lng),MapToCanvasY(CityData[x].Lat));
	}

	/*	this functionality seems to be broken - remove labels for now.
	ctx.textAlign = "left";
	ctx.textBaseline = "bottom";

	if(ClickDataCategory == 1)
		ctx.fillStyle = "black";
	else
		ctx.fillStyle = "darkgray";
	ctx.beginPath();
	ctx.arc(SevereClickArea1[0],SevereClickArea1[1],SevereClickArea1Radius,0,2*Math.PI);
	ctx.fill();
	ctx.closePath();
	ctx.fillText("<-click here to see locations with most cases",SevereClickArea1[0]+10,SevereClickArea1[1]+6);

	if(ClickDataCategory == 2)
		ctx.fillStyle = "black";
	else
		ctx.fillStyle = "darkgray";
	ctx.beginPath();
	ctx.arc(SevereClickArea2[0],SevereClickArea2[1],SevereClickArea2Radius,0,2*Math.PI);
	ctx.fill();
	ctx.closePath();
	ctx.fillText("<-click here to see locations with most cases per capita",SevereClickArea2[0]+10,SevereClickArea2[1]+6);

	ctx.textBaseline = "bottom";
	*/


	ctx.textBaseline = "bottom";

	/*
	MinLng = Math.floor(MinLng);
	MaxLng = Math.ceil(MaxLng);
	MinLat = Math.floor(MinLat);
	MaxLat = Math.ceil(MaxLat);

	// console.log("MinLng = " + MinLng + " MaxLng = " + MaxLng);
	// console.log("MinLat = " + MinLat + " MaxLat = " + MaxLat);

	// draw lat/long lines
	ctx.fillStyle = "#000000";
	for(y=25;y<50;y++)
	{
		for(x=-124;x<-66;x++)
		{
			ctx.fillRect(MapToCanvasX(x),MapToCanvasY(y),2,2);
			// console.log("x = " + MapToCanvasX(x) + " y = " + MapToCanvasY(y));
		}
	}
	*/
}

// figure out max values
function PrepData()
{
	var di,x,y,z;
	var TransLng,TransLat;

	for(di=0;di<ReportDate.length;di++)
	{
		for(x=0;x<ReportDate[di].Data.length;x++)
		{
			var Data = ReportDate[di].Data[x];

			// round lat/long values to 6 digits - the higher precision digits appear to be inaccurate across different reporting days

			Data.Long = Number(Number(Data.Long).toFixed(6));
			Data.Lat = Number(Number(Data.Lat).toFixed(6));
		
			Data.ScaledCases = Math.floor(Math.sqrt(ReportDate[di].Data[x].Cases));

			// make specific check to add population stats for New York City since it's not a county, but relevant to this display.
			// this will let the chart calculations happen later in the logic even though it's county level logic.
			if(Data.Adm.localeCompare("New York City") == 0)
				Data.Pop = 8175133;	// Census 2010 population for New York

			// if((Data.Pop > 0) && (Data.Cases > 0))
			if(Data.Pop > 0)
			{
				Data.PerCapita = Data.Cases / Data.Pop;
				Data.DeathsPerCapita = Data.Deaths / Data.Pop;
				if(Data.Cases > 0)
					Data.DeathRate = Data.Deaths / Data.Cases;
				else
					Data.DeathRate = 0;
				// console.log("dr = " + Data.DeathRate + " d = " + Data.Deaths + " c = " + Data.Cases);
			}
			else
			{
				Data.PerCapita = 0;
				Data.DeathsPerCapita = 0;
				Data.DeathRate = 0;
			}

		}

		ReportDate[di].MostPerCapitaIndex = new Array(MaxSummary);
		ReportDate[di].MostCasesIndex = new Array(MaxSummary);

		for(y=0;y<MaxSummary;y++)
		{
			ReportDate[di].MostPerCapitaIndex[y] = 0;
			ReportDate[di].MostCasesIndex[y] = 0;
		}

		// now sort out worse off areas.
		for(x=0;x<ReportDate[di].Data.length;x++)
		{
			var Data = ReportDate[di].Data[x];

			for(z=0;z<MaxSummary;z++)
			{
				if(Data.Cases > ReportDate[di].Data[ReportDate[di].MostCasesIndex[z]].Cases)
				{
					for(y=MaxSummary-1;y>z;y--)
						ReportDate[di].MostCasesIndex[y] = ReportDate[di].MostCasesIndex[y-1];
					ReportDate[di].MostCasesIndex[z] = x;
					break;
				}
			}

			for(z=0;z<MaxSummary;z++)
			{
				if(Data.PerCapita > ReportDate[di].Data[ReportDate[di].MostPerCapitaIndex[z]].PerCapita)
				{
					for(y=MaxSummary-1;y>z;y--)
						ReportDate[di].MostPerCapitaIndex[y] = ReportDate[di].MostPerCapitaIndex[y-1];
					ReportDate[di].MostPerCapitaIndex[z] = x;
					break;
				}
			}
		}

		/*
		console.log("For index " + DateIndex + " Dated " + ReportDate[DateIndex].Date);
		for(y=0;y<MaxSummary;y++)
		{
			console.log("Rank: " + y + " Cases is " + ReportDate[DateIndex].Data[ReportDate[DateIndex].MostCasesIndex[y]].Adm + ", " + ReportDate[DateIndex].Data[ReportDate[DateIndex].MostCasesIndex[y]].Prov);
			console.log(" with " + ReportDate[DateIndex].Data[ReportDate[DateIndex].MostCasesIndex[y]].Cases + " cases");
			console.log("Rank: " + y + " Cases per capita is " + ReportDate[DateIndex].Data[ReportDate[DateIndex].MostPerCapitaIndex[y]].Adm + ", " + ReportDate[DateIndex].Data[ReportDate[DateIndex].MostPerCapitaIndex[y]].Prov);
			console.log(" with " + ReportDate[DateIndex].Data[ReportDate[DateIndex].MostPerCapitaIndex[y]].PerCapita + " per capita cases");
		}
		*/

		// Finally - sort counties by FIPS
		ReportDate[di].Data.sort(function(a,b) { return a.FIPS - b.FIPS } );
	}
}


function DrawCaseData()
{
	var Lat,Lng,c,x;
	// ctx.strokeStyle = "#000000";
	// ctx.globalAlpha = 1.0;
	ctx.lineWidth = 1;
	var MaxCases = 0;
	var s = 5;

	for(x=0;x<ReportDate[DateIndex].Data.length;x++)
	{
		if(ReportDate[DateIndex].Data[x].ScaledCases > MaxCases)
			MaxCases = ReportDate[DateIndex].Data[x].ScaledCases;
	}
	for(x=0;x<ReportDate[DateIndex].Data.length;x++)
	{
		var Data = ReportDate[DateIndex].Data[x];

		c = Math.floor(Data.ScaledCases/4);
		// console.log("C = " + c);
		if((Data.ScaledCases > 1) && (c == 0))
			c = 1;
		if(c >= SeverityColors.length)
			c = SeverityColors.length-1;
		ctx.fillStyle = SeverityColors[c];
		ctx.strokeStyle = SeverityColors[c];
		Lat = MapToCanvasY(Data.Lat);
		Lng = MapToCanvasX(Data.Long);

		var Alpha = 0.2 + (Data.ScaledCases / MaxCases);
		if(Alpha > 1.0)
			Alpha = 1.0;
		ctx.globalAlpha = Alpha;
		// ctx.globalAlpha = 1.0;
		ctx.beginPath();
		ctx.arc(Lng,Lat,s,0,2*Math.PI);
		ctx.fill();
		// ctx.stroke();
		ctx.closePath();
		/*	 old circles - were getting too large
		ctx.beginPath();
		ctx.arc(Lng,Lat,2+Math.floor(Data.ScaledCases/DrawScaleFactor),0,2*Math.PI);
		ctx.globalAlpha = 0.1;
		ctx.fill();
		ctx.globalAlpha = 0.5;
		ctx.stroke();
		ctx.closePath();
		*/
	}
	ctx.globalAlpha = 1.0;
}

function DrawDeathData()
{
	var Lat,Lng,d,x,c;
	ctx.strokeStyle = "#000000";
	ctx.globalAlpha = 0.3;
	// ctx.globalAlpha = 1.0;
	var s = 5;
	for(x=0;x<ReportDate[DateIndex].Data.length;x++)
	{
		var Data = ReportDate[DateIndex].Data[x];

		d = Data.Deaths;
		if(d > 1)
		{
			if(d > 1000)
				c = DeathSeverityColors.length-1;
			else
				if(d > 500)
					c = DeathSeverityColors.length-2;
				else
					if(d > 100)
						c = DeathSeverityColors.length-3;
					else
						if(d > 10)
							c = DeathSeverityColors.length-4;
						else
							c = 0;

			ctx.fillStyle = DeathSeverityColors[c];
			Lat = MapToCanvasY(Data.Lat);
			Lng = MapToCanvasX(Data.Long);
			// ctx.globalAlpha = 1.0;
			ctx.beginPath();
			ctx.arc(Lng,Lat,s,0,2*Math.PI);
			ctx.fill();
			// ctx.stroke();
			ctx.closePath();
			/*
			ctx.beginPath();
			ctx.arc(Lng,Lat,2+Math.floor(Data.ScaledCases/DrawScaleFactor),0,2*Math.PI);
			ctx.fill();
			// ctx.stroke();
			ctx.closePath();
			*/
		}
	}
}

function DrawCaseGrowth()
{
	var Lat,Lng,d,x,c;
	ctx.strokeStyle = "#000000";
	ctx.globalAlpha = 0.5;
	// ctx.globalAlpha = 1.0;
	var s = 5;
	var dce;
	for(x=0;x<ReportDate[DateIndex].Data.length;x++)
	{
		var Data = ReportDate[DateIndex].Data[x];

		dce = Data.DailyCasesEntry;
		if(typeof dce == "undefined")
			continue;

		if(dce.MovingAveragePercentCaseGrowth[DateIndex] < -2)
			c = GrowthPercentColors[0];
		else
			if(dce.MovingAveragePercentCaseGrowth[DateIndex] < -1)
				c = GrowthPercentColors[1];
			else
				if(dce.MovingAveragePercentCaseGrowth[DateIndex] < -0.5)
					c = GrowthPercentColors[2];
				else
					if(dce.MovingAveragePercentCaseGrowth[DateIndex] < -0.1)
						c = GrowthPercentColors[3];
					else
						if(dce.MovingAveragePercentCaseGrowth[DateIndex] < 0.0)
							c = GrowthPercentColors[4];
						else
							if(dce.MovingAveragePercentCaseGrowth[DateIndex] < 0.1)
								c = GrowthPercentColors[5];
							else
								if(dce.MovingAveragePercentCaseGrowth[DateIndex] < 0.5)
									c = GrowthPercentColors[6];
								else
									if(dce.MovingAveragePercentCaseGrowth[DateIndex] < 1)
										c = GrowthPercentColors[7];
									else
										if(dce.MovingAveragePercentCaseGrowth[DateIndex] < 2)
											c = GrowthPercentColors[8];
										else
											c = GrowthPercentColors[9];


		ctx.fillStyle = c;
		Lat = MapToCanvasY(Data.Lat);
		Lng = MapToCanvasX(Data.Long);
		ctx.beginPath();
		ctx.arc(Lng,Lat,s,0,2*Math.PI);
		ctx.fill();
		ctx.closePath();
	}
}

function DrawDeathGrowth()
{
	var Lat,Lng,d,x,c;
	ctx.strokeStyle = "#000000";
	ctx.globalAlpha = 0.5;
	// ctx.globalAlpha = 1.0;
	var s = 5;
	var dce;
	for(x=0;x<ReportDate[DateIndex].Data.length;x++)
	{
		var Data = ReportDate[DateIndex].Data[x];

		dce = Data.DailyCasesEntry;
		if(typeof dce == "undefined")
			continue;

		if(dce.MovingAveragePercentDeathGrowth[DateIndex] < -2)
			c = GrowthPercentColors[0];
		else
			if(dce.MovingAveragePercentDeathGrowth[DateIndex] < -1)
				c = GrowthPercentColors[1];
			else
				if(dce.MovingAveragePercentDeathGrowth[DateIndex] < -0.5)
					c = GrowthPercentColors[2];
				else
					if(dce.MovingAveragePercentDeathGrowth[DateIndex] < -0.1)
						c = GrowthPercentColors[3];
					else
						if(dce.MovingAveragePercentDeathGrowth[DateIndex] < 0.0)
							c = GrowthPercentColors[4];
						else
							if(dce.MovingAveragePercentDeathGrowth[DateIndex] < 0.1)
								c = GrowthPercentColors[5];
							else
								if(dce.MovingAveragePercentDeathGrowth[DateIndex] < 0.5)
									c = GrowthPercentColors[6];
								else
									if(dce.MovingAveragePercentDeathGrowth[DateIndex] < 1)
										c = GrowthPercentColors[7];
									else
										if(dce.MovingAveragePercentDeathGrowth[DateIndex] < 2)
											c = GrowthPercentColors[8];
										else
											c = GrowthPercentColors[9];


		ctx.fillStyle = c;
		Lat = MapToCanvasY(Data.Lat);
		Lng = MapToCanvasX(Data.Long);
		ctx.beginPath();
		ctx.arc(Lng,Lat,s,0,2*Math.PI);
		ctx.fill();
		ctx.closePath();
	}
}

function CalcAverages2()
{
	var a,x,y,z;
	var StartTime;
	
	// initialize array - push all FIPS reports from first day
	console.log("Start.");
	StartTime = Date.now();

	for(x=0;x<ReportDate[0].Data.length;x++)
	{
		DailyCases.push({			Adm: ReportDate[0].Data[x].Adm, 
									Prov: ReportDate[0].Data[x].Prov, 
									FIPS: ReportDate[0].Data[x].FIPS, 
									Pop: ReportDate[0].Data[x].Pop,
									SqMi: ReportDate[0].Data[x].SqMi,
									Lat: ReportDate[0].Data[x].Lat,
									Long: ReportDate[0].Data[x].Long,
									Date: [],
									TotalCases: [],
									Cases: [],
									TotalDeaths: [],
									Deaths: [] });

		// populate first days data while we are here..
		DailyCases[x].Date.push(ReportDate[0].Date);
		DailyCases[x].TotalCases.push(ReportDate[0].Data[x].Cases);
		DailyCases[x].Cases.push(ReportDate[0].Data[x].Cases);
		DailyCases[x].TotalDeaths.push(ReportDate[0].Data[x].Deaths);
		DailyCases[x].Deaths.push(ReportDate[0].Data[x].Deaths);
	}

	console.log(Date.now() - StartTime + ":Initial first day " + DailyCases.length + " entry county list created");

	// now we need to search for missing FIPS areas that that are not reported consistently (daily) and add them to the list
	// so that the first day is a comprehensive list of every FIPS that reported on any given day.
	/* Commented out - testing showed that all counties had reported on first day and this loop takes 24 seconds to run in Firefox..
	for(x=1;x<ReportDate.length;x++)
	{
		// ReportDate[x].Data.sort( function(a,b) { return a.FIPS - b.FIPS } );
		for(y=0;y<ReportDate[x].Data.length;y++)
		{
			for(z=0;z<DailyCases.length;z++)
			{
				if(DailyCases[z].FIPS == ReportDate[x].Data[y].FIPS)
					break;
				if(DailyCases[z].FIPS > ReportDate[x].Data[y].FIPS)
					z = DailyCases.length;
			}
			if(z == DailyCases.length)	// not found add to end
			{
				console.log("Adding: " + ReportDate[x].Data[y].Adm + ", " + ReportDate[x].Data[y].Prov);
				z = DailyCases.push({			Adm: ReportDate[x].Data[y].Adm, 
												Prov: ReportDate[x].Data[y].Prov, 
												FIPS: ReportDate[x].Data[y].FIPS, 
												Pop: ReportDate[x].Data[y].Pop,
												SqMi: ReportDate[x].Data[y].SqMi,
												Lat: ReportDate[0].Data[x].Lat,
												Long: ReportDate[0].Data[x].Long,
												Date: [],
												TotalCases: [],
												Cases: [],
												TotalDeaths: [],
												Deaths: [] });
				// populate first days data with 0/blanks since they didn't report then..
				DailyCases[z-1].Date.push("");
				DailyCases[z-1].TotalCases.push(0);
				DailyCases[z-1].Cases.push(0);
				DailyCases[z-1].TotalDeaths.push(0);
				DailyCases[z-1].Deaths.push(0);

				// make backward reference for convenience
				ReportDate[x].Data[y].DailyCasesEntry = DailyCases[z-1];
			}
		}
	}

	console.log(Date.now() - StartTime + ":Additional counties found and added, list now " + DailyCases.length + " size");
	*/

	// sort dailycases by FIPS for fun
	// DailyCases.sort(function(a,b) { return a.FIPS - b.FIPS } );

	// First day is done - now do rest of dates onward, populate date, daily cases, fatailities, 
	for(x=1;x<ReportDate.length;x++)	// hundreds of days
	{
		for(z=0;z<DailyCases.length;z++)	// thousands of counties
		{
			// create defaults
			DailyCases[z].Date.push("noreport");
			DailyCases[z].TotalCases.push(0);
			DailyCases[z].Cases.push(0);
			DailyCases[z].TotalDeaths.push(0);
			DailyCases[z].Deaths.push(0);

			a = DailyCases[z].Date.length-1;

			// for(y=0;y<ReportDate[x].Data.length;y++)	// thousands of counties
			for(y=z-600<0?0:y=z-600;y<ReportDate[x].Data.length;y++)	// as an optimization, only look in the index region of where we think it will be
			{
				// if we get a match - populate with real values
				if(ReportDate[x].Data[y].FIPS == DailyCases[z].FIPS)
				{
					DailyCases[z].Date[a] = ReportDate[x].Date;
					DailyCases[z].TotalCases[a] = ReportDate[x].Data[y].Cases;
					DailyCases[z].Cases[a] = ReportDate[x].Data[y].Cases;
					DailyCases[z].TotalDeaths[a] = ReportDate[x].Data[y].Deaths;
					DailyCases[z].Deaths[a] = ReportDate[x].Data[y].Deaths;

					// make backward reference for convenience
					ReportDate[x].Data[y].DailyCasesEntry = DailyCases[z];

					break;
				}

				if(ReportDate[x].Data[y].FIPS > DailyCases[z].FIPS)	// further optimization - skip rest of array if we missed it.
					y = ReportDate[x].Data.length;
			}
			if(y == ReportDate[x].Data.length) // if was not found - it must have been an unreported day, use prior days numbers
			{
				DailyCases[z].Cases[a] = DailyCases[z].Cases[a-1];
				DailyCases[z].TotalCases[a] = DailyCases[z].TotalCases[a-1];
				DailyCases[z].Deaths[a] = DailyCases[z].Deaths[a-1];
				DailyCases[z].TotalDeaths[a] = DailyCases[z].TotalDeaths[a-1];
			}
		}
	}
	console.log(Date.now() - StartTime + ":Remaining dates added");

	// final step (whew) - create incremental daily case and death counts from the data and moving averages
	var MovingAveragePeriod = 10;
	var ActualMovingAveragePeriod;
	var MovingAverageTotalCases;
	var MovingAverageTotalDeaths;
	var PeakCaseIndex;
	var PeakDeathIndex;
	for(x=DailyCases.length-1;x>=0;x--)
	{
		// Determine daily case load by subtracting from prior day totals - counting backward
		for(y=DailyCases[x].Date.length-1;y>0;y--)
		{
			if(DailyCases[x].Cases[y] > 0)
				DailyCases[x].Cases[y] -= DailyCases[x].Cases[y-1];
			if(DailyCases[x].Deaths[y] > 0)
				DailyCases[x].Deaths[y] -= DailyCases[x].Deaths[y-1];

		}
		DailyCases[x].CaseRank = new Array(DailyCases[x].Date.length);
		DailyCases[x].DeathRank = new Array(DailyCases[x].Date.length);
		DailyCases[x].MovingAverageCases = new Array(DailyCases[x].Date.length);
		DailyCases[x].MovingAverageDeaths = new Array(DailyCases[x].Date.length);
		DailyCases[x].MovingAverageCases[0] = DailyCases[x].Cases[0];
		DailyCases[x].MovingAverageDeaths[0] = DailyCases[x].Deaths[0];
		DailyCases[x].DaysSincePeakCases = new Array(DailyCases[x].Date.length);
		DailyCases[x].DaysSincePeakDeaths = new Array(DailyCases[x].Date.length);
		DailyCases[x].MovingAveragePercentCaseGrowth = new Array(DailyCases[x].Date.length);
		DailyCases[x].MovingAveragePercentDeathGrowth = new Array(DailyCases[x].Date.length);
		DailyCases[x].DaysSincePeakCases[0] = DailyCases[x].Date.length-1;
		DailyCases[x].DaysSincePeakDeaths[0] = DailyCases[x].Date.length-1;
		DailyCases[x].PeakCaseIndex = 0;
		DailyCases[x].PeakDeathIndex = 0;
		// for(y=DailyCases[x].Date.length-1;y>=0;y--)
		for(y=0;y<DailyCases[x].Date.length;y++)
		{
			// determining peak index and days since a peak
			if(y != 0)
			{
				if(DailyCases[x].Cases[y] > DailyCases[x].Cases[DailyCases[x].PeakCaseIndex])
				{
					DailyCases[x].DaysSincePeakCases[y] = 0;
					DailyCases[x].PeakCaseIndex = y;
				}
				else
					DailyCases[x].DaysSincePeakCases[y] = DailyCases[x].DaysSincePeakCases[y-1]+1;
	
				if(DailyCases[x].Deaths[y] > DailyCases[x].Deaths[DailyCases[x].PeakDeathIndex])
				{
					DailyCases[x].DaysSincePeakDeaths[y] = 0;
					DailyCases[x].PeakDeathIndex = y;
				}
				else
					DailyCases[x].DaysSincePeakDeaths[y] = DailyCases[x].DaysSincePeakDeaths[y-1]+1;

				// average period calculations
				if(y < MovingAveragePeriod)
					ActualMovingAveragePeriod = y;
				else
					ActualMovingAveragePeriod = MovingAveragePeriod;
	
				MovingAverageTotalCases = 0;
				MovingAverageTotalDeaths = 0;
	
				for(z=y;z>y-ActualMovingAveragePeriod;z--)
				{
					MovingAverageTotalCases += DailyCases[x].Cases[z];
					MovingAverageTotalDeaths += DailyCases[x].Deaths[z];
				}
				DailyCases[x].MovingAverageCases[y] = Math.ceil(MovingAverageTotalCases / ActualMovingAveragePeriod);
				DailyCases[x].MovingAverageDeaths[y] = Math.ceil(MovingAverageTotalDeaths / ActualMovingAveragePeriod);

				var NumeratorCases,NumeratorDeaths,DenominatorCases,DenominatorDeaths;
				if(ActualMovingAveragePeriod < MovingAveragePeriod)
				{
					if(DailyCases[x].MovingAverageCases[y] - DailyCases[x].Cases[0] == 0)
						DailyCases[x].MovingAveragePercentCaseGrowth[y] = 0;
					else
					{
						NumeratorCases = (DailyCases[x].MovingAverageCases[y] - DailyCases[x].Cases[0]);
						DenominatorCases = DailyCases[x].Cases[0] == 0 ? 1 : DailyCases[x].Cases[0];
						DailyCases[x].MovingAveragePercentCaseGrowth[y] = NumeratorCases / DenominatorCases;
					}

					if(DailyCases[x].MovingAverageDeaths[y] - DailyCases[x].Deaths[0] == 0)
						DailyCases[x].MovingAveragePercentDeathGrowth[y] = 0;
					else
					{
						NumeratorDeaths = (DailyCases[x].MovingAverageDeaths[y] - DailyCases[x].Deaths[0]);
						DenominatorDeaths = DailyCases[x].Deaths[0] == 0 ? 1 : DailyCases[x].Deaths[0];
						DailyCases[x].MovingAveragePercentDeathGrowth[y] = NumeratorDeaths / DenominatorDeaths;
					}

					// DailyCases[x].MovingAveragePercentCaseGrowth[y] = (DailyCases[x].MovingAverageCases[y] - DailyCases[x].Cases[0]) / (DailyCases[x].Cases[0] == 0?1:DailyCases[x].Cases[0]);
					// DailyCases[x].MovingAveragePercentDeathGrowth[y] = (DailyCases[x].MovingAverageDeaths[y] - DailyCases[x].Deaths[0]) / (DailyCases[x].Deaths[0] == 0?1:DailyCases[x].Deaths[0]);
				}
				else
				{
					if(DailyCases[x].MovingAverageCases[y] - DailyCases[x].MovingAverageCases[y-MovingAveragePeriod] == 0)
						DailyCases[x].MovingAveragePercentCaseGrowth[y] = 0;
					else
					{
						NumeratorCases = (DailyCases[x].MovingAverageCases[y] - DailyCases[x].MovingAverageCases[y-MovingAveragePeriod]);
						DenominatorCases = DailyCases[x].MovingAverageCases[y-MovingAveragePeriod] == 0 ? 1 : DailyCases[x].MovingAverageCases[y-MovingAveragePeriod];
						DailyCases[x].MovingAveragePercentCaseGrowth[y] = NumeratorCases / DenominatorCases;
					}

					if(DailyCases[x].MovingAverageDeaths[y] - DailyCases[x].MovingAverageDeaths[y-MovingAveragePeriod] == 0)
						DailyCases[x].MovingAveragePercentDeathGrowth[y] = 0;
					else
					{
						NumeratorDeaths = (DailyCases[x].MovingAverageDeaths[y] - DailyCases[x].MovingAverageDeaths[y-MovingAveragePeriod]);
						DenominatorDeaths = DailyCases[x].MovingAverageDeaths[y-MovingAveragePeriod] == 0 ? 1 : DailyCases[x].MovingAverageDeaths[y-MovingAveragePeriod];
						DailyCases[x].MovingAveragePercentDeathGrowth[y] = NumeratorDeaths / DenominatorDeaths;
					}
					// DailyCases[x].MovingAveragePercentCaseGrowth[y] = (DailyCases[x].MovingAverageCases[y] - DailyCases[x].MovingAverageCases[y-MovingAveragePeriod]) / DailyCases[x].MovingAverageCases[y];
					// DailyCases[x].MovingAveragePercentDeathGrowth[y] = (DailyCases[x].MovingAverageDeaths[y] - DailyCases[x].MovingAverageDeaths[y-MovingAveragePeriod]) / DailyCases[x].MovingAverageDeaths[y-MovingAveragePeriod];
				}
			}
		}
	}

	console.log(Date.now() - StartTime + ":Incremental daily case and death counts and moving averages done.");

	// Calculate national rankings
	var sc = new Array(DailyCases.length);	// entry for each county
	for(x=0;x<DailyCases[0].Date.length;x++)	// loop each date
	{
		for(y=0;y<DailyCases.length;y++)
		{
			sc[y] = { 
						OriginalIndex: y, 
						MovingAverageCases: DailyCases[y].MovingAverageCases[x],
						MovingAverageDeaths: DailyCases[y].MovingAverageDeaths[x]
						// MovingAverageCases: DailyCases[y].TotalCases[x],
						// MovingAverageDeaths: DailyCases[y].TotalDeaths[x]
					};
		}

		sc.sort(function(a,b) { return (a.MovingAverageCases - b.MovingAverageCases); } );

		// assign case rankings for that date
		for(y=0;y<DailyCases.length;y++)
			DailyCases[sc[y].OriginalIndex].CaseRank[x] = DailyCases.length - y;

		sc.sort(function(a,b) { return (a.MovingAverageDeaths - b.MovingAverageDeaths); } );

		// assign death rankings for that date
		for(y=0;y<DailyCases.length;y++)
			DailyCases[sc[y].OriginalIndex].DeathRank[x] = DailyCases.length - y;
	}

	console.log(Date.now() - StartTime + ":Assigning national rankings done.");

	StatusMsg.innerHTML = "Done, ready.";
	Controls.style.visibility = "visible";
	// UpdateClickData(SevereClickArea1[0],SevereClickArea1[1]);
	DrawClickData();
	DrawData();
	DrawClickDataCounties();
	DrawUSAMap();

	PlayButton.disabled = false;
	PauseButton.disabled = true;
	ReverseButton.disabled = false;
	FastForwardButton.disabled = false;
	Forward1FrameButton.disabled = false;
	Backward1FrameButton.disabled = false;
	PlayButton.style.visibility= "visible";
	PauseButton.style.visibility = "hidden";
	ReverseButton.style.visibility = "visible";
	FastForwardButton.style.visibility = "visible";
	Forward1FrameButton.style.visibility = "visible";
	Backward1FrameButton.style.visibility = "visible";
}

function DaysSinceLastPeak(ReportCases)
{
	var Lat,Lng,x,c,Cases;
	ctx.strokeStyle = "#000000";
	ctx.globalAlpha = 0.5;

	var s = 5;
	var Days;

	for(x=0;x<DailyCases.length;x++)
	{
		if(ReportCases)
			Days = DailyCases[x].DaysSincePeakCases[DateIndex];	// cases
		else
			Days = DailyCases[x].DaysSincePeakDeaths[DateIndex];// deaths

		c = DecToHex(Days * 20);
		ctx.fillStyle = "#ff" + c + c;
		Lat = MapToCanvasY(DailyCases[x].Lat);
		Lng = MapToCanvasX(DailyCases[x].Long);
		// ctx.globalAlpha = 1.0;
		ctx.beginPath();
		ctx.arc(Lng,Lat,s,0,2*Math.PI);
		ctx.fill();
		// ctx.stroke();
		ctx.closePath();
	}
}

function NationalRanking(ReportCases)
{
	var Lat,Lng,x,c,Cases;
	ctx.globalAlpha = 1;
	ctx.textAlign = "center";
	ctx.textBaseline = "middle";
	ctx.font = "normal 12pt Courier";

	var s = 10;
	var Rank;

	for(x=0;x<DailyCases.length;x++)
	{
		if(ReportCases)
			Rank = DailyCases[x].CaseRank[DateIndex];	 // cases
		else
			Rank = DailyCases[x].DeathRank[DateIndex];   // deaths

		if(Rank > 20)
			continue;

		// ctx.fillStyle = "#" + c + c + c;
		Lat = MapToCanvasY(DailyCases[x].Lat);
		Lng = MapToCanvasX(DailyCases[x].Long);
		ctx.strokeStyle = "black";
		ctx.fillStyle = "red";
		ctx.beginPath();
		ctx.lineWidth = 2;
		ctx.arc(Lng,Lat,s,0,2*Math.PI);
		ctx.fill();
		ctx.stroke();
		ctx.lineWidth = 3;
		ctx.fillStyle = "white";
		ctx.strokeStyle = "black";
		ctx.arc(Lng,Lat,s,0,2*Math.PI);
		ctx.strokeText((Rank).toString(),Lng,Lat-8);
		ctx.fillText((Rank).toString(),Lng,Lat-8);
		// ctx.closePath();
	}
}

function DrawFatalities(Averaged)
{
	var Lat,Lng,x,c,Cases;
	ctx.strokeStyle = "#000000";
	ctx.globalAlpha = 0.7;

	var s = 5;

	for(x=0;x<DailyCases.length;x++)
	{
		if(Averaged)
			Cases = DailyCases[x].MovingAverageDeaths[DateIndex];	// average
		else
			Cases = DailyCases[x].Deaths[DateIndex];			// raw data

		if(Cases > 1)
		{
			if(Cases > 500)
			{
				c = DeathSeverityColors.length-1;
				s = 50;
			}
			else
				if(Cases > 300)
				{
					c = DeathSeverityColors.length-1;
					s = 40;
				}
				else
					if(Cases > 50)
					{
						c = DeathSeverityColors.length-2;
						s = 30;
					}
					else
						if(Cases > 10)
						{
							c = DeathSeverityColors.length-3;
							s = 10;
						}
						else
							if(Cases > 1)
							{
								c = DeathSeverityColors.length-4;
								s = 5;
							}
							else
							{
								c = 0;
								s = 1;
							}

			ctx.fillStyle = DeathSeverityColors[c];
			Lat = MapToCanvasY(DailyCases[x].Lat);
			Lng = MapToCanvasX(DailyCases[x].Long);
			// ctx.globalAlpha = 1.0;
			ctx.beginPath();
			ctx.arc(Lng,Lat,s,0,2*Math.PI);
			ctx.fill();
			// ctx.stroke();
			ctx.closePath();
		}
	}
}

function DrawAverageDailyCases()
{
	var Lat,Lng,x,c,Cases;
	ctx.strokeStyle = "#000000";
	ctx.globalAlpha = 0.7;

	var s = 5;

	for(x=0;x<DailyCases.length;x++)
	{
		Cases = DailyCases[x].MovingAverageCases[DateIndex];

		if(Cases > 1)
		{
			if(Cases > 1000)
			{
				c = DeathSeverityColors.length-1;
				s = 15;
			}
			else
				if(Cases > 500)
				{
					c = DeathSeverityColors.length-1;
					s = 10;
				}
				else
					if(Cases > 100)
					{
						c = DeathSeverityColors.length-2;
						s = 5;
					}
					else
						if(Cases > 50)
						{
							c = DeathSeverityColors.length-3;
							s = 3;
						}
						else
							if(Cases > 1)
							{
								c = DeathSeverityColors.length-4;
								s = 2;
							}
							else
							{
								c = 0;
								s = 1;
							}

			ctx.fillStyle = DeathSeverityColors[c];
			Lat = MapToCanvasY(DailyCases[x].Lat);
			Lng = MapToCanvasX(DailyCases[x].Long);
			// ctx.globalAlpha = 1.0;
			ctx.beginPath();
			ctx.arc(Lng,Lat,s,0,2*Math.PI);
			ctx.fill();
			// ctx.stroke();
			ctx.closePath();
		}
	}
}

function DrawDailyCases()
{
	var Lat,Lng,x,c,Cases;
	ctx.strokeStyle = "#000000";
	ctx.globalAlpha = 0.7;

	var s = 5;

	for(x=0;x<DailyCases.length;x++)
	{
		Cases = DailyCases[x].Cases[DateIndex];

		if(Cases > 1)
		{
			if(Cases > 1000)
			{
				c = DeathSeverityColors.length-1;
				s = 10;
			}
			else
				if(Cases > 500)
				{
					c = DeathSeverityColors.length-1;
					s = 7;
				}
				else
					if(Cases > 100)
					{
						c = DeathSeverityColors.length-2;
						s = 5;
					}
					else
						if(Cases > 50)
						{
							c = DeathSeverityColors.length-3;
							s = 3;
						}
						else
							if(Cases > 1)
							{
								c = DeathSeverityColors.length-4;
								s = 2;
							}
							else
								c = 0;

			ctx.fillStyle = DeathSeverityColors[c];
			Lat = MapToCanvasY(DailyCases[x].Lat);
			Lng = MapToCanvasX(DailyCases[x].Long);
			// ctx.globalAlpha = 1.0;
			ctx.beginPath();
			ctx.arc(Lng,Lat,s,0,2*Math.PI);
			ctx.fill();
			// ctx.stroke();
			ctx.closePath();
		}
	}
}

function DrawData()
{
	var x;

	switch(DisplayIndex)
	{
		case	0:	// 10 day average daily cases
					DrawAverageDailyCases();
					break;
		case	1:	// 10 day fatality average
					DrawFatalities(true);
					break;
		case	2:	// days since last peak cases reported
					DaysSinceLastPeak(true);
					break;
		case	3:	// days since last peak fatalities reported
					DaysSinceLastPeak(false);
					break;
		case	4:	// National case ranking
					NationalRanking(true);
					break;
		case	5:	// National fatality ranking
					NationalRanking(false);
					break;
		case	6:  // Daily cases raw data
					DrawDailyCases();
					break;
		case	7:	// fatality raw data
					DrawFatalities(false);
					break;
		case	8:	// total case data
					DrawCaseData();
					break;
		case	9:	// total Deaths per county
					DrawDeathData();
					break;
		case	10:	// Growing / Receding trend - cases
					DrawCaseGrowth();
					break;
		case	11:	// Growing / Receding trend - deaths
					DrawDeathGrowth();
					break;
	}
}

function XYChart(TopLeft, SizeXY, XEmphasis, XYLabels, ValueSeries1, ValueSeries2)
{
	var x,y;
	var Max = 0;
	var XScale,YScale;
	var GrowthPercent;

	for(x=0;x<ValueSeries1.length;x++)
	{
		if(Max < ValueSeries1[x])
			Max = ValueSeries1[x];
		if(Max < ValueSeries2[x])
			Max = ValueSeries2[x];
	}

	YScale = SizeXY[1] / Max;
	XScale = SizeXY[0] / (ValueSeries1.length-1);	// subtract 1 because Y axis is first point on scale

	ctx.globalAlpha = 1.0;
	ctx.strokeStyle = "black";
	ctx.lineWidth = 2;
	ctx.textAlign = "center";
	ctx.textBaseline = "bottom";

	ctx.beginPath();
	ctx.moveTo(TopLeft[0],TopLeft[1]);
	ctx.lineTo(TopLeft[0],TopLeft[1]+SizeXY[1]);
	ctx.lineTo(TopLeft[0]+SizeXY[0],TopLeft[1]+SizeXY[1]);
	// ctx.closePath();
	ctx.stroke();
	ctx.lineWidth = 1;
	ctx.font = "normal 6pt Courier";
	ctx.strokeText(XYLabels[0],TopLeft[0]+(SizeXY[0]/2),TopLeft[1]+SizeXY[1]+20);
	ctx.strokeText(Max,TopLeft[0]+8,TopLeft[1]);
	for(x=0;x<=ValueSeries1.length-1;x++)
	{
		if(x == XEmphasis)
		{
			ctx.globalAlpha = 1.0;
			ctx.lineWidth = 3;
			ctx.strokeStyle = "green";
		}
		else
		{
			ctx.globalAlpha = 0.5;
			ctx.lineWidth = 1;
			ctx.strokeStyle = "gray";
		}
		ctx.beginPath();
		ctx.moveTo(TopLeft[0]+(XScale*x),TopLeft[1]);
		ctx.lineTo(TopLeft[0]+(XScale*x),TopLeft[1]+SizeXY[1]);
		ctx.stroke();
		ctx.lineWidth = 1;
		if((x % 30) == 0)
		{
			ctx.globalAlpha = 1.0;
			// ctx.strokeStyle = "black";
			ctx.strokeText(x,TopLeft[0]+(XScale*x),TopLeft[1]+SizeXY[1]+10);
		}
	}
	
	// draw series1 shape and fill
	ctx.globalAlpha = 0.5;
	ctx.strokeStyle = "darkred";
	ctx.fillStyle = "darkred";
	ctx.beginPath();
	//ctx.moveTo(TopLeft[0],TopLeft[1]+(SizeXY[1]-ValueSeries1[0]));
	ctx.moveTo(TopLeft[0],TopLeft[1]+(SizeXY[1]-(ValueSeries1[0]*YScale)));
	for(x=1;x<ValueSeries1.length;x++)
		ctx.lineTo(TopLeft[0]+(XScale*x),TopLeft[1]+(SizeXY[1]-(ValueSeries1[x]*YScale)));
	ctx.lineTo(TopLeft[0]+SizeXY[0],TopLeft[1]+SizeXY[1]);
	ctx.lineTo(TopLeft[0],TopLeft[1]+SizeXY[1]);
	ctx.stroke();
	ctx.closePath();
	ctx.fill();

	// draw series1 growth shapes and fill **_**
	ctx.globalAlpha = 0.5;
	// console.log("---");
	for(x=1;x<ValueSeries1.length;x++)
	{
		if(ValueSeries1[x-1] == 0)
			ctx.fillStyle = "gray";
		else
		{
			GrowthPercent = Number((ValueSeries1[x] - ValueSeries1[x-1]) / ValueSeries1[x-1]);
			if(GrowthPercent > 0.2)
				ctx.fillStyle = GrowthRateColors[5];
			else
				if(GrowthPercent > 0.1)
					ctx.fillStyle = GrowthRateColors[4];
				else
					if(GrowthPercent > 0.05)
						ctx.fillStyle = GrowthRateColors[3];
					else
						if(GrowthPercent > 0.01)
							ctx.fillStyle = GrowthRateColors[2];
						else
							if(GrowthPercent > 0.001)
								ctx.fillStyle = GrowthRateColors[1];
							else
								if(GrowthPercent < 0)
									ctx.fillStyle = "gray";	// invalid data
								else
									ctx.fillStyle = GrowthRateColors[0];
			// console.log("Growth percent = " + GrowthPercent + " fillstyle = " + ctx.fillStyle);
		}
		ctx.beginPath();
		ctx.moveTo(TopLeft[0]+(XScale*(x-1)),TopLeft[1]+(SizeXY[1]-(ValueSeries1[x-1]*YScale)));
		ctx.lineTo(TopLeft[0]+(XScale*x),TopLeft[1]+(SizeXY[1]-(ValueSeries1[x]*YScale)));
		ctx.lineTo(TopLeft[0]+(XScale*x),TopLeft[1]);
		ctx.lineTo(TopLeft[0]+(XScale*(x-1)),TopLeft[1]);
		ctx.lineTo(TopLeft[0]+(XScale*(x-1)),TopLeft[1]+(SizeXY[1]-(ValueSeries1[x-1]*YScale)));
		ctx.closePath();
		ctx.fill();
	}

	// draw series2 shape and fill
	ctx.globalAlpha = 0.5;
	ctx.strokeStyle = "white";
	ctx.fillStyle = "black";
	ctx.beginPath();
	// ctx.moveTo(TopLeft[0],TopLeft[1]+(SizeXY[1]-ValueSeries2[0]));
	ctx.moveTo(TopLeft[0],TopLeft[1]+(SizeXY[1]-(ValueSeries2[0]*YScale)));
	for(x=1;x<ValueSeries2.length;x++)
		ctx.lineTo(TopLeft[0]+(XScale*x),TopLeft[1]+(SizeXY[1]-(ValueSeries2[x]*YScale)));
	ctx.lineTo(TopLeft[0]+SizeXY[0],TopLeft[1]+SizeXY[1]);
	ctx.lineTo(TopLeft[0],TopLeft[1]+SizeXY[1]);
	ctx.stroke();
	ctx.closePath();
	ctx.fill();

	ctx.textAlign = "left";
	ctx.textBaseline = "bottom";
}

function Pie(CenterX, CenterY, Radius, Amounts, Labels)
{
	var x,y;
	var cx,cy;
	var lx,ly;
	var Total = 0;
	var Percents = [];
	var Radians = [];
	var LineWidth = 20;
	var RadiansSoFar = 0;
 
	var Color1 = "#7878A0";
	var Color2 = "#404080";
	var Color3 = "#9090C0";
 
	for(x=0;x<Amounts.length;x++)
	{
		Total += Amounts[x];
	}

	if(Total == 0)
	{
		ctx.textAlign = "center";
		ctx.textBaseline = "bottom";
		ctx.fillStyle = "10px Courier black";
		ctx.fillText("(No data to report)",CenterX,CenterY);
		ctx.textAlign = "left";
		ctx.textBaseline = "bottom";
		return;
	}
 
	for(x=0;x<Amounts.length;x++)
	{
		Percents[x] = Amounts[x] / Total;
	}
 
	for(x=0;x<Amounts.length;x++)
	{
		Radians[x] = Percents[x] * (Math.PI * 2);
	}
 
	// ctx.font = "normal 8pt Courier";
	// ctx.setBaseline = "top";
	// ctx.textBaseline="middle";
	ctx.textAlign = "center";
	ctx.textBaseline = "bottom";
	for(x=0;x<Amounts.length;x++)
	{
		// draw arc of graph
		// ctx.fillStyle = ctx.strokeStyle = x==0?Color3:(x%2)==1?Color1:Color2;
		ctx.strokeStyle = ctx.fillStyle = CountyColors[x];
		ctx.beginPath();
		ctx.lineWidth = LineWidth;
		ctx.arc(CenterX,CenterY,Radius,RadiansSoFar,RadiansSoFar + Radians[x]);
		ctx.stroke();
 
		// draw label line and label
		ctx.beginPath();
		ctx.lineWidth = 2;
		lx = cx = CenterX + (Radius * Math.cos(RadiansSoFar+(Radians[x]/2)));
		ly = cy = CenterY + (Radius * Math.sin(RadiansSoFar+(Radians[x]/2)));
		ctx.moveTo(cx,cy);
		cx = CenterX + ((Radius+10) * Math.cos(RadiansSoFar+(Radians[x]/2)));
		cy = CenterY + ((Radius+10) * Math.sin(RadiansSoFar+(Radians[x]/2)));
		ctx.lineTo(cx,cy);
		ctx.stroke();

		// Draw separating line
		/*
		ctx.beginPath();
		ctx.strokeStyle = "white";
		ctx.lineWidth = 5;
		cx = CenterX+((Radius * Math.cos(RadiansSoFar+Radians[x]))*1.2);
		cy = CenterY+((Radius * Math.sin(RadiansSoFar+Radians[x]))*1.2);
		ctx.moveTo(CenterX,CenterY);
		ctx.lineTo(cx,cy);
		ctx.stroke();
		*/

		RadiansSoFar += Radians[x];
	}

	// draw labels on top of pie segments
	RadiansSoFar = 0;
	ctx.lineWidth = 1;
	ctx.fillStyle = "black";
	ctx.strokeStyle = "white";
	for(x=0;x<Amounts.length;x++)
	{
		cx = CenterX + ((Radius+10) * Math.cos(RadiansSoFar+(Radians[x]/2)));
		cy = CenterY + ((Radius+10) * Math.sin(RadiansSoFar+(Radians[x]/2)));
		ctx.strokeText(Labels[x],cx,cy);
		ctx.fillText(Labels[x],cx,cy);
		RadiansSoFar += Radians[x];
	}

	// draw total amount in center
	ctx.fillStyle = "black";
	ctx.strokeStyle = "white";
	ctx.strokeText(Total,CenterX,CenterY);
	ctx.fillText(Total,CenterX,CenterY);

	ctx.textAlign = "left";
	ctx.textBaseline = "bottom";
}

function UpdateClickData(mx,my)
{
	var x,y,z;
	var cx,cy;
	var Sort = 0;
	var MinSevereArea1X = SevereClickArea1[0] - SevereClickArea1Radius;
	var MaxSevereArea1X = SevereClickArea1[0] + SevereClickArea1Radius;
	var MinSevereArea1Y = SevereClickArea1[1] - SevereClickArea1Radius;
	var MaxSevereArea1Y = SevereClickArea1[1] + SevereClickArea1Radius;
	var MinSevereArea2X = SevereClickArea2[0] - SevereClickArea2Radius;
	var MaxSevereArea2X = SevereClickArea2[0] + SevereClickArea2Radius;
	var MinSevereArea2Y = SevereClickArea2[1] - SevereClickArea2Radius;
	var MaxSevereArea2Y = SevereClickArea2[1] + SevereClickArea2Radius;

	ClickData.length = 0;

	if(	(mx > MinSevereArea1X) &&
		(mx < MaxSevereArea1X) &&
		(my > MinSevereArea1Y) &&
		(my < MaxSevereArea1Y))
	{
		for(x=0;x<MaxSummary;x++)
		{
			var Data = ReportDate[DateIndex].Data[ReportDate[DateIndex].MostCasesIndex[x]];
			Data.HistoryData = new Array(ReportDate.length);
			ClickData[ClickData.length] = Data;
		}
		Sort = 0;
		ClickDataCategory = 1;
	}
	else
	{
		if(	(mx > MinSevereArea2X) &&
			(mx < MaxSevereArea2X) &&
			(my > MinSevereArea2Y) &&
			(my < MaxSevereArea2Y))
		{
			for(x=0;x<MaxSummary;x++)
			{
				var Data = ReportDate[DateIndex].Data[ReportDate[DateIndex].MostPerCapitaIndex[x]];
				Data.HistoryData = new Array(ReportDate.length);
				ClickData[ClickData.length] = Data;
			}
			Sort = 0;
			ClickDataCategory = 2;
		}
		else
		{
			for(x=0;x<ReportDate[DateIndex].Data.length;x++)
			{
				var Data = ReportDate[DateIndex].Data[x];
	
				cx = MapToCanvasX(Data.Long);
				cy = MapToCanvasY(Data.Lat);
				if(	(cx > (mx - Tolerance)) &&
					(cx < (mx + Tolerance)) &&
					(cy > (my - Tolerance)) &&
					(cy < (my + Tolerance)))
				{
					if(ClickData.length == MaxSummary)
						break;
	
					Data.HistoryData = new Array(ReportDate.length);	// for tying clickdata to other dates for graphs
		
					ClickData[ClickData.length] = Data;
				}
			}
			Sort = 1;
			ClickDataCategory = 0;
		}
	}

	// now that we have the relevant counties, we need to tie all historical dates to it
	for(z=0;z<ClickData.length;z++)
	{
		for(x=0;x<ReportDate.length;x++)
		{
			for(y=0;y<ReportDate[x].Data.length;y++)
			{
				if((ReportDate[x].Data[y].FIPS == ClickData[z].FIPS)||	// some counties (particularly in CA and TX) were not reporing the same FIPS code consistently
				((ReportDate[x].Data[y].Lat == ClickData[z].Lat) && (ReportDate[x].Data[y].Long == ClickData[z].Long)))
				{
					ClickData[z].HistoryData[x] = ReportDate[x].Data[y];
					break;
				}
			}
		}
	}

	if(Sort)
		ClickData.sort(function(a,b) { return(a.Adm.localeCompare(b.Adm)); });
}

function MouseDown(Event)
{
	var mx,my;

	mx = Event.pageX;
	my = Event.pageY;
	mx -= canvas.offsetLeft;
	my -= canvas.offsetTop;

	LastClickedX = mx;
	LastClickedY = my;

	UpdateClickData(mx,my);
	ClearScreen();
	// DrawUSAMap();
	DrawClickData();
	DrawData();
	DrawClickDataCounties();
	DrawUSAMap();
}

function DrawClickData()
{
	var FontSize;
	var dx,dy;
	var x,y;
	var z;
	var StatColumn = 100;
	var ChartColumn = 140;
	var Amounts = [];
	var Labels = [];
	var ChartCases = [];
	var ChartFatalities = [];

	dx = RightDrawAreaStart;
	dy = 100;
	FontSize = 10;
	// ctx.fillStyle = "darkgray";
	ctx.fillStyle = "white";
	ctx.fillRect(RightDrawAreaStart,0,canvas.width-RightDrawAreaStart,canvas.height);
	ctx.textAlign = "left";
	ctx.textBaseline = "middle";
	if(ClickData.length == 0)
	{
		/*
		ctx.font = "normal 12px Courier";
		ctx.fillStyle = "black";
		ctx.fillText("No county data here",dx,dy);
		*/
		ctx.fillStyle = "blue";
		ctx.font = "normal 14pt Courier";
		ctx.fillText("Click on map for detailed statistics in that area",SevereClickArea2[0]+10,SevereClickArea2[1]+30);
	}
	else
	{
		// pie charts
		ctx.font = "normal 12px Courier";
		ctx.fillStyle = "blue";
		ctx.fillText("Geo " + Math.floor(ClickData[0].Lat) + " by " + Math.floor(ClickData[0].Long) + "(" + ClickData[0].Prov + ")",dx-20,dy);

		dy += 16;
		// ctx.fillText("Date " + ReportDate[DateIndex].Date,dx,dy);

		dy += 16;
		ctx.font = "normal 12px Courier";
		ctx.textAlign = "center";
		ctx.fillStyle = "black";
		ctx.fillText("Case Distribution",dx+60,dy);
		ctx.textAlign = "left"

		for(x=0;x<ClickData.length;x++)
		{
			Amounts[x] = ClickData[x].Cases;
			Labels[x] = ClickData[x].Adm;
		}

		dy += 80;
		Pie(dx+60,dy,60,Amounts,Labels);

		for(x=0;x<ClickData.length;x++)
			Amounts[x] = ClickData[x].Deaths;

		dy += 110;
		ctx.font = "normal 12px Courier";
		ctx.fillStyle = "black";
		ctx.textAlign = "center";
		ctx.fillText("Fatality distribution",dx+60,dy);
		ctx.textAlign = "left";

		dy += 80;
		Pie(dx+60,dy,60,Amounts,Labels);

		// Detailed stats
		dx = 30;
		for(x=0;x<ClickData.length;x++)
		{
			dy = BottomDrawAreaStart;
			ctx.globalAlpha = 1.0;
			ctx.font = "normal 12px Courier";
			// ctx.fillStyle = "blue";
			ctx.fillStyle = CountyColors[x];
			if(ClickData[x].SqMi!= 0)
			{
				if(ClickData[x].Prov.localeCompare("Louisiana") == 0)
					ctx.fillText(ClickData[x].Adm + " Parish",dx,dy);
				else
					ctx.fillText(ClickData[x].Adm + " County",dx,dy);
			}
			else
					ctx.fillText(ClickData[x].Adm,dx,dy);

			dy += FontSize;
			ctx.font = "normal 8px Courier";
			ctx.fillStyle = "gray";
			ctx.fillText(ClickData[x].Prov,dx,dy);
			if(ClickData[x].Pop!= 0)
			{
				dy += FontSize;
				ctx.fillStyle = "green";
				ctx.fillText("Pop:",dx,dy);
				ctx.fillText(ClickData[x].Pop,dx+StatColumn,dy);
			}
			if(ClickData[x].SqMi!= 0)
			{
				dy += FontSize;
				ctx.fillText("Square Miles:",dx,dy);
				ctx.fillText(ClickData[x].SqMi,dx+StatColumn,dy);
			}
			dy += FontSize;
			ctx.fillStyle = "black";
			ctx.fillText("Total Cases:",dx,dy);
			ctx.fillStyle = "darkred";
			ctx.fillText(ClickData[x].Cases,dx+StatColumn,dy);
			dy += FontSize;
			ctx.fillStyle = "black";
			ctx.fillText("Total Deaths:",dx,dy);
			ctx.fillStyle = "darkred";
			ctx.fillText(ClickData[x].Deaths,dx+StatColumn,dy);
			/*  // recovered data is always 0 in JH data.. (shrug..)
			dy += FontSize;
			ctx.fillStyle = "black";
			ctx.fillText("Recovered:",dx,dy);
			ctx.fillStyle = "darkred";
			ctx.fillText(ClickData[x].Recovered,dx+StatColumn,dy);
			*/
			if(ClickData[x].Pop!= 0)
			{
				dy += FontSize;
				ctx.fillStyle = "black";
				ctx.fillText("Cases Per Capita:",dx,dy);
				ctx.fillStyle = "darkred";
				z = (ClickData[x].PerCapita * 100).toFixed(3);
				ctx.fillText(z + "%",dx+StatColumn,dy);
				dy += FontSize;
				ctx.fillStyle = "black";
				ctx.fillText("Deaths Per Capita:",dx,dy);
				ctx.fillStyle = "darkred";
				z = (ClickData[x].DeathsPerCapita * 100).toFixed(3);
				ctx.fillText(z + "%",dx+StatColumn,dy);
				dy += FontSize;
				ctx.fillStyle = "black";
				ctx.fillText("Death Rate:",dx,dy);
				ctx.fillStyle = "darkred";
				z = (ClickData[x].DeathRate * 100).toFixed(3);
				ctx.fillText(z + "%",dx+StatColumn,dy);
			}

			try 
			{
				dy += FontSize;
				ctx.fillStyle = "black";
				ctx.fillText(ClickData[x].DailyCasesEntry.Date[DateIndex] + " Cases:",dx,dy);
				ctx.fillStyle = "darkred";
				ctx.fillText(ClickData[x].DailyCasesEntry.Cases[DateIndex],dx+StatColumn,dy);

				dy += FontSize;
				ctx.fillStyle = "black";
				ctx.fillText("10 Day Avg Cases:",dx,dy);
				ctx.fillStyle = "darkred";
				ctx.fillText(ClickData[x].DailyCasesEntry.MovingAverageCases[DateIndex],dx+StatColumn,dy);

				dy += FontSize;
				ctx.fillStyle = "black";
				ctx.fillText("Nat'l Rank Avg Cases:",dx,dy);
				ctx.fillStyle = "darkred";
				ctx.fillText(ClickData[x].DailyCasesEntry.CaseRank[DateIndex],dx+StatColumn,dy);

				dy += FontSize;
				ctx.fillStyle = "black";
				ctx.fillText(ClickData[x].DailyCasesEntry.Date[DateIndex] + " Deaths:",dx,dy);
				ctx.fillStyle = "darkred";
				ctx.fillText(ClickData[x].DailyCasesEntry.Deaths[DateIndex],dx+StatColumn,dy);

				dy += FontSize;
				ctx.fillStyle = "black";
				ctx.fillText("10 Day Avg Deaths:",dx,dy);
				ctx.fillStyle = "darkred";
				ctx.fillText(ClickData[x].DailyCasesEntry.MovingAverageDeaths[DateIndex],dx+StatColumn,dy);

				dy += FontSize;
				ctx.fillStyle = "black";
				ctx.fillText("Nat'l Rank Avg Fatal:",dx,dy);
				ctx.fillStyle = "darkred";
				ctx.fillText(ClickData[x].DailyCasesEntry.DeathRank[DateIndex],dx+StatColumn,dy);
			}
			catch(err)
			{
				dy += FontSize * 3;
				ctx.fillStyle = "black";
				ctx.fillText("- no data - ",dx,dy);
			}

			dy += 5;
			if(ClickData[x].Pop!= 0)
			{
				ChartCases.length = 0;
				ChartFatalities.length = 0;
				for(y=0;y<ClickData[x].HistoryData.length;y++)
				{
					if(ClickData[x].HistoryData[y])
					{
						ChartCases[y] = ClickData[x].HistoryData[y].Cases;
						ChartFatalities[y] = ClickData[x].HistoryData[y].Deaths;
					}
					else
					{
						ChartCases[y] = 0;
						ChartFatalities[y] = 0;
					}
				}
				XYChart([dx+ChartColumn,BottomDrawAreaStart],[130,120],DateIndex,["Days since 3/22",""],ChartCases,ChartFatalities);
			}

			dx += DetailedStatsSpacing;
		}
	}	
	ctx.textAlign = "left";
	ctx.textBaseline = "bottom";
}

function DrawClickDataCounties()
{
	var x;

	// Draw selected counties
	ctx.globalAlpha = 1.0;
	if(ClickData.length != 0)
	{
		for(x=0;x<ClickData.length;x++)
		{
			ctx.fillStyle = CountyColors[x];
			ctx.strokeStyle = "black";
			ctx.LineWidth = 4;
			ctx.beginPath();
			ctx.moveTo(MapToCanvasX(ClickData[x].Long),MapToCanvasY(ClickData[x].Lat));
			ctx.lineTo(MapToCanvasX(ClickData[x].Long)-Tolerance,MapToCanvasY(ClickData[x].Lat)+Tolerance);
			ctx.lineTo(MapToCanvasX(ClickData[x].Long)+Tolerance,MapToCanvasY(ClickData[x].Lat)+Tolerance);
			ctx.lineTo(MapToCanvasX(ClickData[x].Long),MapToCanvasY(ClickData[x].Lat));
			ctx.closePath();
			// ctx.stroke();
			ctx.fill();
			// ctx.fillRect(MapToCanvasX(ClickData[x].Long)-(Tolerance/2),MapToCanvasY(ClickData[x].Lat)-(Tolerance/2),Tolerance,Tolerance);
		}
	}
	ctx.font = "italic 12px Courier";
	ctx.fillStyle = "black";
	ctx.textAlign = "left";
	ctx.textBaseline = "middle";
	ctx.fillText("Data Sources: Johns Hopkins University, United States Census",10,10);
	ctx.font = "italic 20px Courier";
	ctx.fillStyle = "blue";
	ctx.fillText(DisplayOptions[DisplayIndex] + ", " + ReportDate[DateIndex].Date, MapTitleLocation[0], MapTitleLocation[1]);
	ctx.font = "normal 10px Courier";
	ctx.fillStyle = "white";
	ctx.fillText("Click on map for county level detail or", MapTitleLocation[0], MapTitleLocation[1]+24);
}

function UpdateDay(value)
{
	DateIndex = value;
	DateSlider.value = DateIndex;
	DateSet.innerHTML = ReportDate[DateIndex].Date;

	ClearScreen();
	// DrawUSAMap();
	// PrepData();
	if(ClickData.length != 0)
		UpdateClickData(LastClickedX, LastClickedY);
	DrawClickData();
	DrawData();
	DrawClickDataCounties();
	DrawUSAMap();
}

var StatusMsg = document.getElementById("StatusText");
StatusMsg.innerHTML = "Done loading - calculating county figures...";

var ClickData = [];
var ClickDataCategory;
var Tolerance = 10;
var RightDrawAreaStart = 1020;
var BottomDrawAreaStart = 500;
var LastClickedX = 0;
var LastClickedY = 0;
var DetailedStatsSpacing = 280;
var CountyColors = [ "#1c1a6e","#696e1a","#1a6e28","#1b6769","#645c65","#ba4a00" ];
var SeverityColors = [ "#c0c0c0", "#ff6a1f", "#ba4000", "#ff0000" ];
// var SeverityColors = [ "#c0c0c0", "c0c080", "c0c040", "c0c000", "e0e000", "f0f000", "f0c000", "f0a000", "f08000", "f04000", "ff0000" ];
// var DeathSeverityColors = [ "#c0c0c0", "#ff6a1f", "#ba4000", "#ff4000", "#ff0000" ];
var DeathSeverityColors = [ "#808080", "#c0c0c0", "#ba4000", "#ff4000", "#ff0000" ];
var DeathRateColors = [ "#c0c0c0", "#a0a0a0", "#808080", "#404040", "#000000" ];
var GrowthRateColors = [ "#ffffff", "#ffc0c0", "#ffa090", "#ff7050", "#ff3600", "#ff0000" ];
// var GrowthPercentColors = [ "#186a3b", "#239b56", "#2ecc71", "#82e0aa", "#eafaf1", "#fbeee6", "#edbb99", "#dc7633", "#a04000", "#6e2c00" ];
var GrowthPercentColors = [ "#00ff00", "#40ff40", "#80ff80", "#a0ffa0", "#c0ffc0", "#ffc0c0", "#ffa0a0", "#ff8080", "#ff4040", "#ff0000" ];
var canvas = document.getElementById("USAMap");
var ctx = canvas.getContext("2d");
var DrawScaleFactor = 2;
var DateIndex = ReportDate.length-1;	// Start with latest date in set
var DisplayOptions = [ 		
							"10 Day Daily Case Average",			// 0
							"10 Day Fatality Average",				// 1
							"Days Since Peak Cases Reported",		// 2
							"Days Since Peak Fatalities Reported",	// 3
							"20 Worst 10 Day Average Caseload",		// 4
							"20 Worst 10 Day Average Fatalities",	// 5
							"Raw Daily Cases Reported",				// 6
							"Raw Fatality Cases Reported",			// 7
							"Total Cases", 							// 8
							"Total Deaths",							// 9 
							"10 Day Average Case Growth Trends",	// 10
							"10 Day Average Fatality Growth Trends"	// 11
					];
var DisplayIndex = 0;
var MaxSummary = 4;
var SevereClickArea1 = [];
SevereClickArea1[0] = 20;
SevereClickArea1[1] = 440;
SevereClickArea1Radius = 8;
var SevereClickArea2 = [];
SevereClickArea2[0] = 20;
SevereClickArea2[1] = 460;
SevereClickArea2Radius = 8;
var MapTitleLocation = [];
MapTitleLocation[0] = 550;
MapTitleLocation[1] = 10;

var DailyCases = [];

// ReportDate.Averaged = false;
ClearScreen();
// DrawUSAMap();
PrepData();
// CalcAverages2(); //  put in timer instead 
// UpdateClickData(SevereClickArea1[0],SevereClickArea1[1]);
// DrawClickData();
// DrawData();
// DrawClickDataCounties();
// DrawUSAMap();

var DateSlider = document.getElementById("DateCtrl");
var DateSet = document.getElementById("CurrentDateSet");
DateSet.innerHTML = ReportDate[DateIndex].Date;
DateSlider.min = 0;
DateSlider.max = ReportDate.length-1;
DateSlider.value = DateIndex;
DateSlider.oninput = function() 
{
	// console.log("Slider value = " + this.value);
	UpdateDay(this.value);
}

var DisplaySelect = document.getElementById("DisplaySelect");
for(x=0;x<DisplayOptions.length;x++)
{
	var elem = document.createElement("option");
	elem.text = DisplayOptions[x];
	DisplaySelect.options.add(elem,x);
}
DisplaySelect.selectedIndex = DisplayIndex;
DisplaySelect.onchange = function()
{
	DisplayIndex = DisplaySelect.selectedIndex;
	ClearScreen();
	// DrawUSAMap();
	DrawClickData();
	DrawData();
	DrawClickDataCounties();
	DrawUSAMap();
}

var PlayTimer;
var Playing = false;
var PlayButton = document.getElementById("PlayButton");
var PauseButton = document.getElementById("PauseButton");
var ReverseButton = document.getElementById("ReverseButton");
var FastForwardButton = document.getElementById("FastForwardButton");
var Backward1FrameButton = document.getElementById("Backward1FrameButton");
var Forward1FrameButton = document.getElementById("Forward1FrameButton");

PlayButton.onclick = function()
{
	var Index;
	if(!Playing)
	{
		PlayButton.disabled = true;
		PauseButton.disabled = false;
		ReverseButton.disabled = true;
		FastForwardButton.disabled = true;
		Forward1FrameButton.disabled = true;
		Backward1FrameButton.disabled = true;

		PlayButton.style.visibility= "hidden";
		PauseButton.style.visibility = "visible";
		ReverseButton.style.visibility = "hidden";
		FastForwardButton.style.visibility = "hidden";
		Forward1FrameButton.style.visibility = "hidden";
		Backward1FrameButton.style.visibility = "hidden";

		PlayTimer = setInterval(function() { Index = DateIndex+1; if(Index >= ReportDate.length) Index = 0; UpdateDay(Index); },250);
		Playing = true;
	}
}

PauseButton.onclick = function()
{
	if(Playing)
	{
		PlayButton.disabled = false;
		PauseButton.disabled = true;
		ReverseButton.disabled = false;
		FastForwardButton.disabled = false;
		Forward1FrameButton.disabled = false;
		Backward1FrameButton.disabled = false;

		PlayButton.style.visibility= "visible";
		PauseButton.style.visibility = "hidden";
		ReverseButton.style.visibility = "visible";
		FastForwardButton.style.visibility = "visible";
		Forward1FrameButton.style.visibility = "visible";
		Backward1FrameButton.style.visibility = "visible";

		clearInterval(PlayTimer);
		Playing = false;
	}
}

ReverseButton.onclick = function()
{
	if(!Playing)
		UpdateDay(0);
}

FastForwardButton.onclick = function()
{
	if(!Playing)
		UpdateDay(ReportDate.length-1);
}

Forward1FrameButton.onclick = function()
{
	if(DateIndex != ReportDate.length-1)
		UpdateDay(DateIndex+1);
}

Backward1FrameButton.onclick = function()
{
	if(DateIndex != 0)
		UpdateDay(DateIndex-1);
}

// canvas.addEventListener("mousedown",MouseDown,false);
canvas.addEventListener("click",MouseDown,false);

var StatusMsg = document.getElementById("StatusText");
StatusMsg.innerHTML = "Calculating statistics, this may also take a while.";
// StatusMsg.style.visibility = "hidden";
// StatusMsg.style.display = "none";
var Controls = document.getElementById("Controls");
// Controls.style.visibility = "visible";

// set timer for calculating averages (which is compute intensive)
setTimeout(CalcAverages2,500);

</script>

</html>
